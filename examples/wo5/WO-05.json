{
  "id": "WO-05",
  "title": "Implement default ruleset using movement function",
  "intent": "Create worldsim/rules.py with a default_ruleset function that composes aging, movement, energy updates, reproduction, and death into a single step, enforcing the population invariant.",
  "allowed_files": [
    "worldsim/rules.py",
    "worldsim/types.py",
    "worldsim/movement.py"
  ],
  "forbidden": [
    "Do not modify worldsim/types.py",
    "Do not modify worldsim/movement.py",
    "Do not modify any other existing files",
    "Do not mutate the input agents dict"
  ],
  "acceptance_commands": [
    "python -c \"from worldsim.rules import default_ruleset; from worldsim.types import Position, Agent, SimConfig; import random; agents = {Position(r,c): Agent(10,0,r%4) for r in range(4) for c in range(4) if (r+c)%3!=0}; cfg = SimConfig(width=5, height=5, seed=42); new_a, b, d, m = default_ruleset(agents, 5, 5, cfg, random.Random(42)); assert len(agents)+b-d == len(new_a), f'pop invariant: {len(agents)}+{b}-{d}!={len(new_a)}'\"",
    "python -c \"from worldsim.rules import default_ruleset; from worldsim.types import Position, Agent, SimConfig; import random; agents = {Position(r,c): Agent(10,0,r%4) for r in range(4) for c in range(4) if (r+c)%3!=0}; cfg = SimConfig(width=5, height=5, seed=42); new_a, b, d, m = default_ruleset(agents, 5, 5, cfg, random.Random(42)); newborns = sum(1 for a in new_a.values() if a.age == 0); assert newborns == b, f'newborn count {newborns} != births {b}'\"",
    "python -c \"from worldsim.rules import default_ruleset; from worldsim.types import Position, Agent, SimConfig; import random; agents = {Position(0,0): Agent(10,0,0), Position(1,1): Agent(10,0,2)}; cfg = SimConfig(width=5, height=5, seed=42); r1 = default_ruleset(dict(agents), 5, 5, cfg, random.Random(42)); r2 = default_ruleset(dict(agents), 5, 5, cfg, random.Random(42)); assert r1 == r2, 'not deterministic'\""
  ],
  "context_files": [
    "worldsim/rules.py",
    "worldsim/types.py",
    "worldsim/movement.py"
  ],
  "notes": "IMPORTANT: Read worldsim/movement.py to learn the EXACT signature of move_agents. Read worldsim/types.py for all type definitions.\n\nDefine: default_ruleset(agents: dict[Position, Agent], width: int, height: int, config: SimConfig, rng: random.Random) -> tuple[dict[Position, Agent], int, int, int]. Returns (new_agents, births, deaths, movements). Must NOT mutate the input dict.\n\nPhase 1 — AGE: Create a working copy of agents. For each agent, create a new Agent with age incremented by 1 (same energy, direction).\n\nPhase 2 — MOVE: Call move_agents(aged_agents, width, height, rng) from worldsim.movement. Get back (moved_agents, movements).\n\nPhase 3 — ENERGY: For each agent in moved_agents, create new Agent with energy = energy + config.energy_gain - config.move_cost (same age, direction).\n\nPhase 4 — REPRODUCE: For each (pos, agent) in sorted(energized_agents.items()): if agent.energy >= config.reproduction_threshold, collect the 4 adjacent cells (N/E/S/W with toroidal wrapping) that are NOT keys in the current dict. If any exist, pick one via rng.choice. Place offspring Agent(energy=config.reproduction_cost, age=0, direction=rng.randint(0,3)) at that cell. Reduce parent energy by config.reproduction_cost. Increment births.\n\nPhase 5 — DEATH: Remove agents with energy <= 0 or age > config.max_age. Count deaths.\n\nINVARIANTS:\n- len(input) + births - deaths == len(output)\n- All agents with age == 0 in the output are newborns; their count equals births\n- All other agents have age >= 1\n\nDo NOT modify worldsim/types.py or worldsim/movement.py."
}
