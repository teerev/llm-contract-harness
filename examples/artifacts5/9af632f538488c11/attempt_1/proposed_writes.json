{
  "summary": "Added deterministic core simulation pytest suite covering world creation, movement safety/determinism, rules invariants, and World stepping; updated verify script to run pytest.",
  "writes": [
    {
      "base_sha256": "87945f9eaa188bf4f4412f9522bb7f40e85e870de32d966c7aee07c921ac5887",
      "content": "#!/usr/bin/env bash\nset -euo pipefail\npython -m compileall -q .\npython -m pytest -q\n",
      "path": "scripts/verify.sh"
    },
    {
      "base_sha256": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
      "content": "import random\n\nfrom worldsim.movement import move_agents\nfrom worldsim.rules import default_ruleset\nfrom worldsim.types import Agent, Position, SimConfig, WorldState\nfrom worldsim.world import World, create_world\n\n\ndef _agents_dict_from_state(state: WorldState):\n    return dict(state.agents)\n\n\ndef _positions_unique(agents_dict):\n    positions = list(agents_dict.keys())\n    return len(positions) == len(set(positions))\n\n\ndef test_create_world_returns_worldstate_dimensions_and_step0():\n    config = SimConfig(width=7, height=5, seed=123, initial_density=0.4)\n    world = create_world(config)\n    state = world.get_state()\n\n    assert isinstance(state, WorldState)\n    assert state.width == config.width\n    assert state.height == config.height\n    assert state.step_number == 0\n\n\ndef test_create_world_determinism_same_config_twice_identical_state():\n    config = SimConfig(width=10, height=6, seed=999, initial_density=0.35)\n    w1 = create_world(config)\n    w2 = create_world(config)\n\n    assert w1.get_state() == w2.get_state()\n\n\ndef test_move_agents_preserves_agent_count():\n    agents = {\n        Position(0, 0): Agent(energy=5, age=1, direction=1),\n        Position(0, 2): Agent(energy=5, age=1, direction=3),\n        Position(1, 1): Agent(energy=5, age=1, direction=0),\n    }\n    rng = random.Random(123)\n    out, movements = move_agents(agents, width=4, height=3, rng=rng)\n\n    assert len(out) == len(agents)\n    assert isinstance(movements, int)\n\n\ndef test_move_agents_produces_no_duplicate_positions():\n    agents = {\n        Position(0, 0): Agent(energy=5, age=1, direction=1),\n        Position(0, 1): Agent(energy=5, age=1, direction=3),\n        Position(1, 0): Agent(energy=5, age=1, direction=2),\n        Position(2, 2): Agent(energy=5, age=1, direction=0),\n    }\n    rng = random.Random(0)\n    out, _ = move_agents(agents, width=3, height=3, rng=rng)\n\n    assert _positions_unique(out)\n\n\ndef test_move_agents_is_deterministic():\n    agents = {\n        Position(0, 0): Agent(energy=5, age=1, direction=1),\n        Position(0, 1): Agent(energy=5, age=1, direction=1),\n        Position(1, 1): Agent(energy=5, age=1, direction=2),\n        Position(2, 2): Agent(energy=5, age=1, direction=0),\n    }\n\n    out1, mov1 = move_agents(agents, width=4, height=4, rng=random.Random(42))\n    out2, mov2 = move_agents(agents, width=4, height=4, rng=random.Random(42))\n\n    assert out1 == out2\n    assert mov1 == mov2\n\n\ndef test_default_ruleset_population_invariant():\n    config = SimConfig(\n        width=5,\n        height=5,\n        seed=1,\n        initial_density=0.0,\n        energy_gain=2,\n        move_cost=1,\n        reproduction_threshold=10,\n        reproduction_cost=4,\n        max_age=50,\n    )\n    agents = {\n        Position(2, 2): Agent(energy=20, age=0, direction=0),\n        Position(0, 0): Agent(energy=3, age=0, direction=1),\n    }\n\n    out, births, deaths, _ = default_ruleset(\n        agents, width=config.width, height=config.height, config=config, rng=random.Random(7)\n    )\n\n    assert len(agents) + births - deaths == len(out)\n\n\ndef test_default_ruleset_newborn_counting_age0_equals_births():\n    config = SimConfig(\n        width=6,\n        height=6,\n        seed=2,\n        initial_density=0.0,\n        energy_gain=2,\n        move_cost=1,\n        reproduction_threshold=10,\n        reproduction_cost=4,\n        max_age=50,\n    )\n    agents = {\n        Position(3, 3): Agent(energy=20, age=0, direction=0),\n        Position(1, 1): Agent(energy=20, age=0, direction=2),\n    }\n\n    out, births, deaths, _ = default_ruleset(\n        agents, width=config.width, height=config.height, config=config, rng=random.Random(1234)\n    )\n\n    assert deaths >= 0\n    newborns = sum(1 for a in out.values() if a.age == 0)\n    assert newborns == births\n\n\ndef test_default_ruleset_does_not_mutate_input_dict():\n    config = SimConfig(width=4, height=4, seed=3, initial_density=0.0)\n    agents = {\n        Position(0, 0): Agent(energy=10, age=5, direction=0),\n        Position(1, 1): Agent(energy=10, age=5, direction=1),\n    }\n    agents_before = dict(agents)\n\n    _out, _births, _deaths, _movements = default_ruleset(\n        agents, width=config.width, height=config.height, config=config, rng=random.Random(0)\n    )\n\n    assert agents == agents_before\n\n\ndef test_world_step_increments_step_number():\n    config = SimConfig(width=8, height=8, seed=10, initial_density=0.2)\n    world = create_world(config)\n    s0 = world.get_state()\n    res = world.step()\n\n    assert res.world.step_number == s0.step_number + 1\n\n\ndef test_world_step_determinism_over_10_steps():\n    config = SimConfig(width=10, height=10, seed=42, initial_density=0.25)\n    w1 = create_world(config)\n    w2 = create_world(config)\n\n    for _ in range(10):\n        r1 = w1.step()\n        r2 = w2.step()\n        assert r1.world == r2.world\n        assert (r1.births, r1.deaths, r1.movements) == (r2.births, r2.deaths, r2.movements)\n\n\ndef test_no_cell_collisions_after_step_all_positions_unique():\n    config = SimConfig(width=12, height=9, seed=77, initial_density=0.35)\n    world = create_world(config)\n    res = world.step()\n\n    agents = _agents_dict_from_state(res.world)\n    assert _positions_unique(agents)\n\n\ndef test_energy_bounds_all_agents_energy_gt_0_after_step():\n    config = SimConfig(width=12, height=9, seed=88, initial_density=0.35)\n    world = create_world(config)\n    res = world.step()\n\n    for _pos, agent in res.world.agents:\n        assert agent.energy > 0\n",
      "path": "tests/test_simulation.py"
    }
  ]
}
