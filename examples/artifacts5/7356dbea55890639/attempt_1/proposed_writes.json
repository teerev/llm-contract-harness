{
  "summary": "Added integration tests covering HTML rendering output structure/size and end-to-end determinism across seeds and step counts.",
  "writes": [
    {
      "base_sha256": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
      "content": "import os\nimport re\nimport tempfile\nimport unittest\n\nfrom worldsim.render_html import render_html\nfrom worldsim.types import SimConfig, WorldState\nfrom worldsim.world import create_world\n\n\nclass TestHTMLRenderIntegration(unittest.TestCase):\n    def _make_states(self):\n        # Non-trivial simulation to ensure multiple frames and agents.\n        config = SimConfig(width=12, height=10, seed=7, initial_density=0.35, max_steps=5)\n        w = create_world(config)\n        states = [w.get_state()]\n        for _ in range(5):\n            states.append(w.step().world)\n        return states\n\n    def test_render_html_starts_with_doctype_case_insensitive(self):\n        states = self._make_states()\n        tmpdir = tempfile.mkdtemp()\n        out_path = os.path.join(tmpdir, \"sim.html\")\n\n        render_html(states, out_path)\n\n        with open(out_path, \"r\", encoding=\"utf-8\") as f:\n            prefix = f.read(64)\n\n        self.assertIsNotNone(re.match(r\"\\s*<!doctype\", prefix, flags=re.IGNORECASE))\n\n    def test_render_html_contains_canvas_and_frame_data(self):\n        states = self._make_states()\n        tmpdir = tempfile.mkdtemp()\n        out_path = os.path.join(tmpdir, \"sim.html\")\n\n        render_html(states, out_path)\n\n        html = open(out_path, \"r\", encoding=\"utf-8\").read()\n\n        # Canvas element exists\n        self.assertIn(\"<canvas\", html.lower())\n        # Frame data embedded\n        self.assertIn(\"const FRAMES =\", html)\n        # Basic schema keys present in embedded JSON\n        self.assertIn('\"step\":', html)\n        self.assertIn('\"width\":', html)\n        self.assertIn('\"height\":', html)\n        self.assertIn('\"agents\":', html)\n\n    def test_render_html_file_size_gt_500_bytes_for_non_trivial_input(self):\n        states = self._make_states()\n        tmpdir = tempfile.mkdtemp()\n        out_path = os.path.join(tmpdir, \"sim.html\")\n\n        render_html(states, out_path)\n\n        size = os.path.getsize(out_path)\n        self.assertGreater(size, 500)\n\n\nclass TestEndToEndDeterminism(unittest.TestCase):\n    def _run_steps_get_state(self, config: SimConfig, steps: int) -> WorldState:\n        w = create_world(config)\n        for _ in range(steps):\n            w.step()\n        return w.get_state()\n\n    def test_same_seed_same_final_state_after_10_steps(self):\n        config = SimConfig(width=15, height=12, seed=123, initial_density=0.25)\n\n        s1 = self._run_steps_get_state(config, 10)\n        s2 = self._run_steps_get_state(config, 10)\n\n        self.assertEqual(s1, s2)\n\n    def test_different_seeds_different_final_state_after_20_steps(self):\n        config_a = SimConfig(width=15, height=12, seed=42, initial_density=0.25)\n        config_b = SimConfig(width=15, height=12, seed=99, initial_density=0.25)\n\n        s1 = self._run_steps_get_state(config_a, 20)\n        s2 = self._run_steps_get_state(config_b, 20)\n\n        self.assertNotEqual(s1, s2)\n\n    def test_population_trend_nonzero_and_deterministic_at_step_50(self):\n        config = SimConfig(width=20, height=20, seed=2024, initial_density=0.2)\n\n        def run_and_collect():\n            w = create_world(config)\n            pop = len(w.get_state().agents)\n            self.assertGreater(pop, 0, \"Initial population should be > 0 for density=0.2\")\n\n            for _ in range(50):\n                w.step()\n                pop = len(w.get_state().agents)\n\n            return pop, w.get_state()\n\n        pop1, state1 = run_and_collect()\n        pop2, state2 = run_and_collect()\n\n        self.assertGreater(pop1, 0, \"Population should not instantly collapse to 0 by step 50\")\n        self.assertEqual(pop1, pop2, \"Population at step 50 should match between identical runs\")\n        self.assertEqual(state1, state2, \"Final state at step 50 should match between identical runs\")\n\n\nif __name__ == \"__main__\":\n    unittest.main()\n",
      "path": "tests/test_integration.py"
    }
  ]
}
