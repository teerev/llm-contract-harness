{
  "summary": "Added worldsim/movement.py implementing a pure, collision-safe sequential placement move_agents function with toroidal wrapping, deterministic processing order, and no mutation of input agents.",
  "writes": [
    {
      "base_sha256": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
      "content": "from __future__ import annotations\n\nimport random\nfrom typing import Dict, Tuple\n\nfrom worldsim.types import Agent, Position\n\n\ndef _move_target(pos: Position, direction: int, width: int, height: int) -> Position:\n    \"\"\"Compute the toroidally-wrapped target position for a move.\"\"\"\n    r, c = pos.row, pos.col\n    if direction == 0:  # North\n        r -= 1\n    elif direction == 1:  # East\n        c += 1\n    elif direction == 2:  # South\n        r += 1\n    elif direction == 3:  # West\n        c -= 1\n    else:\n        # Direction is expected to be 0..3; keep behavior safe/deterministic.\n        raise ValueError(f\"Invalid direction: {direction}\")\n\n    return Position(r % height, c % width)\n\n\ndef move_agents(\n    agents: Dict[Position, Agent],\n    width: int,\n    height: int,\n    rng: random.Random,\n) -> Tuple[Dict[Position, Agent], int]:\n    \"\"\"Move agents on a toroidal grid using a collision-safe sequential placement algorithm.\n\n    Pure function: does not mutate the input dict or any Agent values.\n\n    Returns:\n        (new_agents_dict, movements_count)\n    \"\"\"\n    remaining = set(agents.keys())\n    new_agents: Dict[Position, Agent] = {}\n    movements = 0\n\n    for pos, agent in sorted(agents.items(), key=lambda kv: kv[0]):\n        remaining.remove(pos)\n\n        target = _move_target(pos, agent.direction, width, height)\n\n        if target not in new_agents and target not in remaining:\n            final_pos = target\n            movements += 1\n        else:\n            final_pos = pos\n\n        new_dir = rng.randint(0, 3)\n        new_agent = Agent(energy=agent.energy, age=agent.age, direction=new_dir)\n        new_agents[final_pos] = new_agent\n\n    assert len(new_agents) == len(agents), \"Agent count changed during movement\"\n    return new_agents, movements\n",
      "path": "worldsim/movement.py"
    }
  ]
}
