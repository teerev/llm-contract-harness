{
  "summary": "Added worldsim/rules.py implementing default_ruleset that composes aging, movement, energy update, reproduction, and death into a single pure step while enforcing population and newborn invariants. No changes to movement.py or types.py.",
  "writes": [
    {
      "base_sha256": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
      "content": "from __future__ import annotations\n\nimport random\nfrom typing import Dict, List, Tuple\n\nfrom worldsim.movement import move_agents\nfrom worldsim.types import Agent, Position, SimConfig\n\n\ndef _adjacent_positions(pos: Position, width: int, height: int) -> List[Position]:\n    \"\"\"Return N/E/S/W adjacent positions with toroidal wrapping.\"\"\"\n    r, c = pos.row, pos.col\n    return [\n        Position((r - 1) % height, c),  # North\n        Position(r, (c + 1) % width),  # East\n        Position((r + 1) % height, c),  # South\n        Position(r, (c - 1) % width),  # West\n    ]\n\n\ndef default_ruleset(\n    agents: Dict[Position, Agent],\n    width: int,\n    height: int,\n    config: SimConfig,\n    rng: random.Random,\n) -> Tuple[Dict[Position, Agent], int, int, int]:\n    \"\"\"Apply the default simulation ruleset as a single step.\n\n    Phases:\n      1) Age\n      2) Move (via worldsim.movement.move_agents)\n      3) Energy update\n      4) Reproduce\n      5) Death\n\n    Pure function: does not mutate the input dict or any Agent values.\n\n    Returns:\n        (new_agents, births, deaths, movements)\n    \"\"\"\n    # Phase 1 \u2014 AGE\n    aged_agents: Dict[Position, Agent] = {\n        pos: Agent(energy=agent.energy, age=agent.age + 1, direction=agent.direction)\n        for pos, agent in agents.items()\n    }\n\n    # Phase 2 \u2014 MOVE\n    moved_agents, movements = move_agents(aged_agents, width, height, rng)\n\n    # Phase 3 \u2014 ENERGY\n    energized_agents: Dict[Position, Agent] = {\n        pos: Agent(\n            energy=agent.energy + config.energy_gain - config.move_cost,\n            age=agent.age,\n            direction=agent.direction,\n        )\n        for pos, agent in moved_agents.items()\n    }\n\n    # Phase 4 \u2014 REPRODUCE\n    births = 0\n    repro_agents: Dict[Position, Agent] = dict(energized_agents)  # working copy\n\n    for pos, agent in sorted(energized_agents.items(), key=lambda kv: kv[0]):\n        # Parent may have been updated by an earlier reproduction (energy reduced).\n        current_parent = repro_agents.get(pos)\n        if current_parent is None:\n            continue\n\n        if current_parent.energy >= config.reproduction_threshold:\n            candidates = [\n                p for p in _adjacent_positions(pos, width, height) if p not in repro_agents\n            ]\n            if candidates:\n                child_pos = rng.choice(candidates)\n                child = Agent(\n                    energy=config.reproduction_cost,\n                    age=0,\n                    direction=rng.randint(0, 3),\n                )\n                repro_agents[child_pos] = child\n\n                updated_parent = Agent(\n                    energy=current_parent.energy - config.reproduction_cost,\n                    age=current_parent.age,\n                    direction=current_parent.direction,\n                )\n                repro_agents[pos] = updated_parent\n                births += 1\n\n    # Phase 5 \u2014 DEATH\n    deaths = 0\n    final_agents: Dict[Position, Agent] = {}\n    for pos, agent in repro_agents.items():\n        if agent.energy <= 0 or agent.age > config.max_age:\n            deaths += 1\n        else:\n            final_agents[pos] = agent\n\n    # Invariants\n    assert len(agents) + births - deaths == len(final_agents), (\n        \"Population invariant violated: \"\n        f\"len(input)={len(agents)} births={births} deaths={deaths} len(output)={len(final_agents)}\"\n    )\n\n    newborns = sum(1 for a in final_agents.values() if a.age == 0)\n    assert newborns == births, (\n        \"Newborn invariant violated: \"\n        f\"newborns(age==0)={newborns} births={births}\"\n    )\n\n    assert all(a.age >= 1 for a in final_agents.values() if a.age != 0), (\n        \"Age invariant violated: found non-newborn agent with age < 1\"\n    )\n\n    return final_agents, births, deaths, movements\n",
      "path": "worldsim/rules.py"
    }
  ]
}
