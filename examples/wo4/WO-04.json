{
  "id": "WO-04",
  "title": "Implement default ruleset as a pure function",
  "intent": "Create worldsim/rules.py with a default_ruleset function that takes an agents dict and returns a new agents dict plus birth/death/movement counts, with collision-safe movement and correct population accounting.",
  "allowed_files": [
    "worldsim/rules.py",
    "worldsim/types.py"
  ],
  "forbidden": [
    "Do not modify worldsim/types.py",
    "Do not modify any other existing files",
    "Do not use the global random module state — always use the rng parameter",
    "Do not import any external dependencies",
    "Do not mutate the input agents dict — build and return a new one"
  ],
  "acceptance_commands": [
    "python -c \"from worldsim.rules import default_ruleset; from worldsim.types import Position, Agent, SimConfig; import random; agents = {Position(r,c): Agent(10,0,r%4) for r in range(4) for c in range(4) if (r+c)%3!=0}; cfg = SimConfig(width=5, height=5, seed=42); new_a, b, d, m = default_ruleset(agents, 5, 5, cfg, random.Random(42)); assert len(agents)+b-d == len(new_a), f'pop invariant: {len(agents)}+{b}-{d}!={len(new_a)}'\"",
    "python -c \"from worldsim.rules import default_ruleset; from worldsim.types import Position, Agent, SimConfig; import random; agents = {Position(r,c): Agent(10,0,r%4) for r in range(4) for c in range(4) if (r+c)%3!=0}; cfg = SimConfig(width=5, height=5, seed=42); new_a, b, d, m = default_ruleset(agents, 5, 5, cfg, random.Random(42)); positions = list(new_a.keys()); assert len(positions) == len(set(positions)), 'duplicate positions'\"",
    "python -c \"from worldsim.rules import default_ruleset; from worldsim.types import Position, Agent, SimConfig; import random; agents = {Position(0,0): Agent(10,0,0), Position(1,1): Agent(10,0,2)}; cfg = SimConfig(width=5, height=5, seed=42); r1 = default_ruleset(dict(agents), 5, 5, cfg, random.Random(42)); r2 = default_ruleset(dict(agents), 5, 5, cfg, random.Random(42)); assert r1 == r2, 'not deterministic'\""
  ],
  "context_files": [
    "worldsim/rules.py",
    "worldsim/types.py"
  ],
  "notes": "Define: default_ruleset(agents: dict[Position, Agent], width: int, height: int, config: SimConfig, rng: random.Random) -> tuple[dict[Position, Agent], int, int, int]. Returns (new_agents, births, deaths, movements). Must NOT mutate the input agents dict.\n\nThe algorithm has 4 phases, each building on the result of the previous one. Process agents in sorted Position order throughout.\n\nPHASE 1 — AGE: Create a working copy of agents. For each agent, increment age by 1.\n\nPHASE 2 — MOVE (collision-safe sequential placement):\n1. Create remaining = set of all current agent positions (the unprocessed queue).\n2. Create new_agents = {} (empty dict for final positions after movement).\n3. For each (pos, agent) in the working copy sorted by pos:\n   a. Remove pos from remaining (mark this agent as processed).\n   b. Compute target: direction 0=N means row-1, 1=E means col+1, 2=S means row+1, 3=W means col-1. Apply toroidal wrapping: row % height, col % width.\n   c. If target is NOT a key in new_agents AND target is NOT in remaining: move to target, add agent to new_agents[target], increment movements.\n   d. Else: agent stays at pos, add agent to new_agents[pos].\n   e. Update agent: set direction = rng.randint(0, 3), set energy = energy + config.energy_gain - config.move_cost.\n4. ASSERT: len(new_agents) == len(working copy). No agents lost.\n\nPHASE 3 — REPRODUCE: For each (pos, agent) in new_agents sorted by pos: if agent.energy >= config.reproduction_threshold, collect all 4 adjacent cells (N/E/S/W with wrapping) that are NOT keys in new_agents. If any exist, pick one via rng.choice. Place offspring Agent(energy=config.reproduction_cost, age=0, direction=rng.randint(0,3)) into new_agents at that cell. Reduce parent energy by config.reproduction_cost (update in new_agents). Increment births.\n\nPHASE 4 — DEATH: Remove from new_agents all agents where energy <= 0 or age > config.max_age. Count removals as deaths.\n\nINVARIANT: len(input agents) + births - deaths == len(output new_agents). This MUST hold.\n\nDo NOT modify worldsim/types.py."
}
