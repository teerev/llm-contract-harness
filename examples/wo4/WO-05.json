{
  "id": "WO-05",
  "title": "Implement world engine",
  "intent": "Create worldsim/world.py with a World class and create_world factory function that initializes the grid and runs the step loop by calling the ruleset.",
  "allowed_files": [
    "worldsim/world.py",
    "worldsim/types.py",
    "worldsim/rules.py"
  ],
  "forbidden": [
    "Do not modify worldsim/types.py",
    "Do not modify worldsim/rules.py",
    "Do not modify any other existing files",
    "Do not use the global random module state"
  ],
  "acceptance_commands": [
    "python -c \"from worldsim.world import create_world; from worldsim.types import SimConfig; cfg = SimConfig(width=8, height=8, seed=42); w = create_world(cfg); st = w.get_state(); assert st.width == 8 and st.height == 8 and st.step_number == 0 and len(st.agents) > 0\"",
    "python -c \"from worldsim.world import create_world; from worldsim.types import SimConfig; w1 = create_world(SimConfig(8, 8, 42)); w2 = create_world(SimConfig(8, 8, 42)); assert w1.get_state() == w2.get_state(); r1 = w1.step(); r2 = w2.step(); assert r1 == r2, 'not deterministic'\"",
    "python -c \"from worldsim.world import create_world; from worldsim.types import SimConfig; cfg = SimConfig(width=10, height=10, seed=99, initial_density=0.4); w = create_world(cfg); st0 = w.get_state(); p0 = len(st0.agents); r = w.step(); p1 = len(r.world.agents); assert p0 + r.births - r.deaths == p1, f'pop invariant: {p0}+{r.births}-{r.deaths}!={p1}'\""
  ],
  "context_files": [
    "worldsim/world.py",
    "worldsim/types.py",
    "worldsim/rules.py"
  ],
  "notes": "IMPORTANT: Read worldsim/rules.py and worldsim/types.py to learn the EXACT function signature of default_ruleset and all type definitions.\n\nDefine create_world(config: SimConfig) -> World. Use random.Random(config.seed) to place agents: for each cell (row, col) in row-major order (row 0..height-1, col 0..width-1), if rng.random() < config.initial_density, place Agent(energy=config.initial_energy, age=0, direction=rng.randint(0,3)).\n\nClass World:\n- __init__(self, config: SimConfig, state: WorldState, ruleset=None): store config, unpack state.agents into internal dict[Position, Agent], set ruleset to default_ruleset from worldsim.rules if None.\n- step(self) -> StepResult: derive per-step RNG as random.Random(config.seed * 6364136223846793005 + step_number) for deterministic resumability. Call self._ruleset(agents_dict, width, height, config, rng). Update internal agents dict and step_number. Return StepResult with new WorldState and counts.\n- get_state(self) -> WorldState: return immutable snapshot with agents as sorted tuple of (Position, Agent) pairs.\n\nDo NOT modify worldsim/types.py or worldsim/rules.py."
}
