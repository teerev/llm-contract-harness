{
  "summary": "Added comprehensive integration tests covering stats collection, ASCII rendering, checkpoint round-trips, and deterministic end-to-end simulation including checkpoint resume.",
  "writes": [
    {
      "base_sha256": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
      "content": "from __future__ import annotations\n\nimport os\nimport tempfile\n\nfrom lifesim.checkpoint import load_checkpoint, save_checkpoint\nfrom lifesim.render import render_ascii\nfrom lifesim.stats import StatsCollector\nfrom lifesim.types import Agent, Position, SimConfig, StepResult, WorldState\nfrom lifesim.world import World, create_world\n\n\ndef _make_state(\n    *,\n    width: int = 4,\n    height: int = 3,\n    step_number: int = 0,\n    seed: int = 123,\n    agents: tuple[tuple[Position, Agent], ...] = (),\n) -> WorldState:\n    return WorldState(\n        width=width,\n        height=height,\n        step_number=step_number,\n        seed=seed,\n        agents=agents,\n    )\n\n\n# -----------------\n# Stats tests\n# -----------------\n\ndef test_stats_record_population_count() -> None:\n    state = _make_state(\n        agents=(\n            (Position(0, 0), Agent(energy=10, age=0, direction=0)),\n            (Position(1, 2), Agent(energy=3, age=1, direction=2)),\n        )\n    )\n    step_result = StepResult(world=state, births=0, deaths=0, movements=0)\n\n    sc = StatsCollector()\n    metrics = sc.record(step_result)\n\n    assert metrics.population == 2\n    assert metrics.step_number == state.step_number\n\n\ndef test_stats_to_csv_header_and_rows_count() -> None:\n    sc = StatsCollector()\n\n    for i in range(3):\n        state = _make_state(step_number=i, agents=((Position(0, 0), Agent(energy=10, age=i, direction=0)),))\n        sc.record(StepResult(world=state, births=0, deaths=0, movements=0))\n\n    csv_text = sc.to_csv()\n    lines = csv_text.splitlines()\n\n    assert lines[0] == \"step_number,population,births,deaths,avg_energy\"\n    # header + N records\n    assert len(lines) == 1 + 3\n\n\ndef test_stats_avg_energy_zero_when_population_zero() -> None:\n    sc = StatsCollector()\n    state = _make_state(agents=())\n    metrics = sc.record(StepResult(world=state, births=0, deaths=0, movements=0))\n    assert metrics.population == 0\n    assert metrics.avg_energy == 0.0\n\n\n# -----------------\n# Render tests\n# -----------------\n\ndef test_render_ascii_dimensions() -> None:\n    state = _make_state(width=5, height=4, agents=())\n    out = render_ascii(state)\n    lines = out.split(\"\\n\")\n\n    assert len(lines) == 4\n    assert all(len(line) == 5 for line in lines)\n\n\ndef test_render_ascii_agents_and_empty_cells_glyphs() -> None:\n    # energy > 5 => '@', energy 1-5 => 'o', empty => '.'\n    state = _make_state(\n        width=4,\n        height=3,\n        agents=(\n            (Position(0, 1), Agent(energy=6, age=0, direction=0)),  # '@'\n            (Position(2, 3), Agent(energy=1, age=0, direction=0)),  # 'o'\n        ),\n    )\n    out = render_ascii(state)\n    lines = out.split(\"\\n\")\n\n    assert lines[0][1] == \"@\"\n    assert lines[2][3] == \"o\"\n    assert lines[0][0] == \".\"\n    assert lines[1][2] == \".\"\n\n\ndef test_render_ascii_determinism_same_state_same_output() -> None:\n    state = _make_state(\n        width=6,\n        height=2,\n        agents=(\n            (Position(0, 0), Agent(energy=10, age=0, direction=1)),\n            (Position(1, 5), Agent(energy=2, age=3, direction=3)),\n        ),\n    )\n    assert render_ascii(state) == render_ascii(state)\n\n\n# -----------------\n# Checkpoint tests\n# -----------------\n\ndef test_checkpoint_round_trip_identical_worldstate() -> None:\n    state = _make_state(\n        width=7,\n        height=5,\n        step_number=9,\n        seed=999,\n        agents=(\n            (Position(4, 6), Agent(energy=12, age=7, direction=2)),\n            (Position(0, 0), Agent(energy=1, age=0, direction=0)),\n        ),\n    )\n\n    tmpdir = tempfile.mkdtemp()\n    path = os.path.join(tmpdir, \"checkpoint.json\")\n\n    save_checkpoint(state, path)\n    loaded = load_checkpoint(path)\n\n    assert loaded == state\n\n\ndef test_checkpoint_round_trip_empty_agents_tuple() -> None:\n    state = _make_state(width=3, height=3, step_number=0, seed=1, agents=())\n\n    tmpdir = tempfile.mkdtemp()\n    path = os.path.join(tmpdir, \"checkpoint.json\")\n\n    save_checkpoint(state, path)\n    loaded = load_checkpoint(path)\n\n    assert loaded == state\n    assert loaded.agents == ()\n\n\ndef test_checkpoint_round_trip_preserves_all_agent_fields() -> None:\n    state = _make_state(\n        width=4,\n        height=4,\n        step_number=2,\n        seed=42,\n        agents=(\n            (Position(1, 1), Agent(energy=7, age=11, direction=3)),\n            (Position(2, 2), Agent(energy=0, age=0, direction=0)),\n        ),\n    )\n\n    tmpdir = tempfile.mkdtemp()\n    path = os.path.join(tmpdir, \"checkpoint.json\")\n\n    save_checkpoint(state, path)\n    loaded = load_checkpoint(path)\n\n    assert loaded.width == state.width\n    assert loaded.height == state.height\n    assert loaded.step_number == state.step_number\n    assert loaded.seed == state.seed\n\n    # Ensure each agent's energy/age/direction preserved.\n    assert dict(loaded.agents) == dict(state.agents)\n\n\n# -----------------\n# End-to-end tests\n# -----------------\n\ndef test_end_to_end_determinism_same_seed_same_final_state() -> None:\n    config = SimConfig(width=10, height=8, seed=1234, initial_density=0.35, max_steps=100)\n\n    w1 = create_world(config)\n    for _ in range(10):\n        w1.step()\n    s1 = w1.get_state()\n\n    w2 = create_world(config)\n    for _ in range(10):\n        w2.step()\n    s2 = w2.get_state()\n\n    assert s1 == s2\n\n\ndef test_checkpoint_resume_matches_straight_run() -> None:\n    config = SimConfig(width=12, height=9, seed=2025, initial_density=0.3)\n\n    # Straight run 10 steps\n    w_straight = create_world(config)\n    for _ in range(10):\n        w_straight.step()\n    s_straight = w_straight.get_state()\n\n    # Run 5 steps, checkpoint, load into new World, run 5 more\n    w_part = create_world(config)\n    for _ in range(5):\n        w_part.step()\n    s5 = w_part.get_state()\n\n    tmpdir = tempfile.mkdtemp()\n    path = os.path.join(tmpdir, \"resume.json\")\n    save_checkpoint(s5, path)\n    loaded = load_checkpoint(path)\n\n    # Resume: must use loaded.step_number and loaded agents.\n    w_resume = World(config=config, state=loaded)\n    for _ in range(5):\n        w_resume.step()\n    s_resume = w_resume.get_state()\n\n    assert s_resume == s_straight\n",
      "path": "tests/test_integration.py"
    }
  ]
}
