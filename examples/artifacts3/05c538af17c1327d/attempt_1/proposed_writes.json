{
  "summary": "Added deterministic core simulation pytest suite covering world creation, stepping, determinism, and invariants; updated verification script to run pytest.",
  "writes": [
    {
      "base_sha256": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
      "content": "import pytest\n\nfrom lifesim.types import SimConfig\nfrom lifesim.world import create_world\n\n\ndef _positions(world_state):\n    return [pos for (pos, _agent) in world_state.agents]\n\n\ndef _agents_by_pos(world_state):\n    return {pos: agent for (pos, agent) in world_state.agents}\n\n\ndef test_create_world_returns_worldstate_dimensions_step0_and_agents_present_for_density_gt_0():\n    config = SimConfig(width=10, height=8, seed=123, initial_density=0.6)\n    world = create_world(config)\n    state = world.get_state()\n\n    assert state.width == config.width\n    assert state.height == config.height\n    assert state.step_number == 0\n    assert state.seed == config.seed\n    assert len(state.agents) > 0\n\n\ndef test_create_world_determinism_same_config_produces_identical_worldstate():\n    config = SimConfig(width=12, height=9, seed=999, initial_density=0.4)\n    w1 = create_world(config)\n    w2 = create_world(config)\n\n    assert w1.get_state() == w2.get_state()\n\n\ndef test_step_increments_step_number_by_1():\n    config = SimConfig(width=10, height=10, seed=7, initial_density=0.3)\n    world = create_world(config)\n    before = world.get_state()\n    result = world.step()\n\n    assert result.world.step_number == before.step_number + 1\n\n\ndef test_step_determinism_same_initial_state_twice_produces_identical_stepresult():\n    config = SimConfig(width=10, height=10, seed=42, initial_density=0.35)\n\n    w1 = create_world(config)\n    w2 = create_world(config)\n\n    r1 = w1.step()\n    r2 = w2.step()\n\n    assert r1 == r2\n\n\ndef test_no_cell_collisions_after_step():\n    config = SimConfig(width=15, height=12, seed=101, initial_density=0.5)\n    world = create_world(config)\n\n    result = world.step()\n    positions = _positions(result.world)\n\n    assert len(set(positions)) == len(positions)\n\n\ndef test_stepresult_counts_are_non_negative():\n    config = SimConfig(width=10, height=10, seed=202, initial_density=0.4)\n    world = create_world(config)\n\n    result = world.step()\n\n    assert result.births >= 0\n    assert result.deaths >= 0\n    assert result.movements >= 0\n\n\ndef test_multi_step_determinism_10_steps_same_seed_same_final_state():\n    config = SimConfig(width=14, height=11, seed=314159, initial_density=0.33)\n\n    w1 = create_world(config)\n    w2 = create_world(config)\n\n    for _ in range(10):\n        w1.step()\n        w2.step()\n\n    assert w1.get_state() == w2.get_state()\n\n\ndef test_population_invariant_each_step_before_plus_births_minus_deaths_equals_after():\n    config = SimConfig(width=12, height=12, seed=8080, initial_density=0.45)\n    world = create_world(config)\n\n    for _ in range(10):\n        before = world.get_state()\n        before_pop = len(before.agents)\n        result = world.step()\n        after_pop = len(result.world.agents)\n\n        assert before_pop + result.births - result.deaths == after_pop\n\n\ndef test_energy_bounds_all_living_agents_have_energy_gt_0():\n    config = SimConfig(width=10, height=10, seed=55, initial_density=0.5)\n    world = create_world(config)\n\n    for _ in range(10):\n        result = world.step()\n        for _pos, agent in result.world.agents:\n            assert agent.energy > 0\n\n\ndef test_age_monotonicity_agent_ages_only_increase_across_steps_for_survivors():\n    config = SimConfig(width=13, height=9, seed=77, initial_density=0.4)\n    world = create_world(config)\n\n    prev = world.get_state()\n    for _ in range(10):\n        result = world.step()\n        curr = result.world\n\n        prev_map = _agents_by_pos(prev)\n        curr_map = _agents_by_pos(curr)\n\n        # For agents that remain in the same cell across steps, age must increase.\n        # (Movement can change positions; births introduce new agents with age=0.)\n        for pos, prev_agent in prev_map.items():\n            if pos in curr_map:\n                assert curr_map[pos].age > prev_agent.age\n\n        prev = curr\n",
      "path": "tests/test_simulation.py"
    },
    {
      "base_sha256": "87945f9eaa188bf4f4412f9522bb7f40e85e870de32d966c7aee07c921ac5887",
      "content": "#!/usr/bin/env bash\nset -euo pipefail\npython -m compileall -q .\npython -m pytest -q\n",
      "path": "scripts/verify.sh"
    }
  ]
}
