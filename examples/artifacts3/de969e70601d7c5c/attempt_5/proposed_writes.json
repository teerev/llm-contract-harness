{
  "summary": "Fix age monotonicity test to account for births replacing positions; add deterministic core simulation tests; enable pytest in scripts/verify.sh.",
  "writes": [
    {
      "base_sha256": "87945f9eaa188bf4f4412f9522bb7f40e85e870de32d966c7aee07c921ac5887",
      "content": "#!/usr/bin/env bash\nset -euo pipefail\npython -m compileall -q .\npython -m pytest -q\n",
      "path": "scripts/verify.sh"
    },
    {
      "base_sha256": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
      "content": "from __future__ import annotations\n\nfrom typing import Dict, Tuple\n\nfrom lifesim.types import Agent, Position, SimConfig, StepResult, WorldState\nfrom lifesim.world import create_world\n\n\ndef _agents_dict(state: WorldState) -> Dict[Position, Agent]:\n    return {pos: agent for (pos, agent) in state.agents}\n\n\ndef _positions_tuple(state: WorldState) -> Tuple[Position, ...]:\n    return tuple(pos for (pos, _agent) in state.agents)\n\n\ndef test_create_world_returns_worldstate_with_dimensions_step0_and_agents_for_density_gt_0():\n    config = SimConfig(width=12, height=8, seed=123, initial_density=0.6)\n    world = create_world(config)\n    state = world.get_state()\n\n    assert isinstance(state, WorldState)\n    assert state.width == config.width\n    assert state.height == config.height\n    assert state.step_number == 0\n    assert state.seed == config.seed\n    assert len(state.agents) > 0\n\n\ndef test_create_world_determinism_same_config_produces_identical_state():\n    config = SimConfig(width=10, height=7, seed=999, initial_density=0.4)\n    w1 = create_world(config)\n    w2 = create_world(config)\n\n    assert w1.get_state() == w2.get_state()\n\n\ndef test_step_increments_step_number_by_1():\n    config = SimConfig(width=9, height=9, seed=42, initial_density=0.3)\n    world = create_world(config)\n    before = world.get_state()\n    res = world.step()\n\n    assert res.world.step_number == before.step_number + 1\n\n\ndef test_step_determinism_same_initial_state_produces_identical_stepresult():\n    config = SimConfig(width=11, height=6, seed=2024, initial_density=0.5)\n    w1 = create_world(config)\n    w2 = create_world(config)\n\n    r1 = w1.step()\n    r2 = w2.step()\n\n    assert isinstance(r1, StepResult)\n    assert r1 == r2\n\n\ndef test_no_cell_collisions_after_step_unique_positions_equals_population():\n    config = SimConfig(width=15, height=10, seed=7, initial_density=0.7)\n    world = create_world(config)\n\n    for _ in range(5):\n        res = world.step()\n        positions = _positions_tuple(res.world)\n        assert len(set(positions)) == len(positions)\n\n\ndef test_stepresult_counts_are_non_negative():\n    config = SimConfig(width=13, height=9, seed=1234, initial_density=0.5)\n    world = create_world(config)\n\n    for _ in range(10):\n        res = world.step()\n        assert res.births >= 0\n        assert res.deaths >= 0\n        assert res.movements >= 0\n\n\ndef test_multi_step_determinism_10_steps_same_seed_same_final_state():\n    config = SimConfig(width=16, height=8, seed=555, initial_density=0.45)\n    w1 = create_world(config)\n    w2 = create_world(config)\n\n    for _ in range(10):\n        w1.step()\n        w2.step()\n\n    assert w1.get_state() == w2.get_state()\n\n\ndef test_population_invariant_population_before_plus_births_minus_deaths_equals_after_each_step():\n    config = SimConfig(width=14, height=9, seed=31415, initial_density=0.5)\n    world = create_world(config)\n\n    for _ in range(20):\n        before = world.get_state()\n        pop_before = len(before.agents)\n        res = world.step()\n        pop_after = len(res.world.agents)\n\n        assert pop_before + res.births - res.deaths == pop_after\n\n\ndef test_energy_bounds_all_living_agents_have_energy_gt_0():\n    config = SimConfig(width=14, height=9, seed=2718, initial_density=0.6)\n    world = create_world(config)\n\n    for _ in range(15):\n        res = world.step()\n        for _pos, agent in res.world.agents:\n            assert agent.energy > 0\n\n\ndef test_age_monotonicity_ages_only_increase_for_survivors_excluding_births():\n    \"\"\"Ages should never decrease for agents that survive from one step to the next.\n\n    Because agents move and births can place a new agent (age=0) into a position\n    that was previously occupied, we cannot compare by Position. Instead, we\n    compare the multiset of ages after removing the expected number of births.\n\n    In default_ruleset, every surviving pre-step agent is aged by +1 before any\n    reproduction/death filtering, and births always have age=0.\n    \"\"\"\n\n    config = SimConfig(width=14, height=9, seed=31415, initial_density=0.5)\n    world = create_world(config)\n\n    for _ in range(10):\n        before = world.get_state()\n        before_ages_plus1 = sorted(agent.age + 1 for _pos, agent in before.agents)\n\n        res = world.step()\n        after_ages = sorted(agent.age for _pos, agent in res.world.agents)\n\n        # Remove births (age 0) from the after list; remaining are survivors.\n        zeros = sum(1 for a in after_ages if a == 0)\n        assert zeros >= res.births\n        after_survivor_ages = after_ages[res.births:]\n\n        # Survivors are exactly the pre-step agents that did not die.\n        expected_survivors = len(before.agents) - res.deaths\n        assert len(after_survivor_ages) == expected_survivors\n\n        # Each survivor's age must be one of the pre-step ages + 1.\n        # (Order/identity not tracked, so compare as multisets.)\n        assert after_survivor_ages == before_ages_plus1[:expected_survivors]\n",
      "path": "tests/test_simulation.py"
    }
  ]
}
