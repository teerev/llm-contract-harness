{
  "summary": "Added worldsim/rules.py implementing default_ruleset as a pure, deterministic 4-phase ruleset (age, collision-safe movement, reproduction, death) using provided rng and preserving population accounting invariants. No changes to types.py.",
  "writes": [
    {
      "base_sha256": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
      "content": "from __future__ import annotations\n\nimport random\nfrom typing import Dict, Tuple\n\nfrom .types import Agent, Position, SimConfig\n\n\ndef _wrap(pos: Position, width: int, height: int) -> Position:\n    return Position(pos.row % height, pos.col % width)\n\n\ndef _move_target(pos: Position, direction: int, width: int, height: int) -> Position:\n    # 0=N row-1, 1=E col+1, 2=S row+1, 3=W col-1\n    if direction == 0:\n        return _wrap(Position(pos.row - 1, pos.col), width, height)\n    if direction == 1:\n        return _wrap(Position(pos.row, pos.col + 1), width, height)\n    if direction == 2:\n        return _wrap(Position(pos.row + 1, pos.col), width, height)\n    # direction == 3\n    return _wrap(Position(pos.row, pos.col - 1), width, height)\n\n\ndef default_ruleset(\n    agents: Dict[Position, Agent],\n    width: int,\n    height: int,\n    config: SimConfig,\n    rng: random.Random,\n) -> Tuple[Dict[Position, Agent], int, int, int]:\n    \"\"\"Apply the default ruleset as a pure function.\n\n    Returns: (new_agents, births, deaths, movements)\n\n    Constraints:\n      - Does not mutate input agents.\n      - Uses rng for all randomness.\n      - Processes agents in sorted Position order for determinism.\n    \"\"\"\n\n    births = 0\n    deaths = 0\n    movements = 0\n\n    # PHASE 1 \u2014 AGE\n    working: Dict[Position, Agent] = {}\n    for pos in sorted(agents):\n        a = agents[pos]\n        working[pos] = Agent(energy=a.energy, age=a.age + 1, direction=a.direction)\n\n    # PHASE 2 \u2014 MOVE (collision-safe sequential placement)\n    remaining = set(working.keys())\n    moved: Dict[Position, Agent] = {}\n\n    for pos in sorted(working):\n        agent = working[pos]\n        remaining.remove(pos)\n\n        target = _move_target(pos, agent.direction, width, height)\n\n        if (target not in moved) and (target not in remaining):\n            final_pos = target\n            movements += 1\n        else:\n            final_pos = pos\n\n        # Update agent after movement decision\n        new_dir = rng.randint(0, 3)\n        new_energy = agent.energy + config.energy_gain - config.move_cost\n        moved[final_pos] = Agent(energy=new_energy, age=agent.age, direction=new_dir)\n\n    assert len(moved) == len(working), \"Movement phase lost or duplicated agents\"\n\n    # PHASE 3 \u2014 REPRODUCE\n    # Iterate over a snapshot of positions to keep deterministic order while mutating moved.\n    for pos in sorted(moved):\n        parent = moved[pos]\n        if parent.energy < config.reproduction_threshold:\n            continue\n\n        neighbors = (\n            _wrap(Position(pos.row - 1, pos.col), width, height),\n            _wrap(Position(pos.row, pos.col + 1), width, height),\n            _wrap(Position(pos.row + 1, pos.col), width, height),\n            _wrap(Position(pos.row, pos.col - 1), width, height),\n        )\n        empty = [p for p in neighbors if p not in moved]\n        if not empty:\n            continue\n\n        child_pos = rng.choice(empty)\n        child = Agent(energy=config.reproduction_cost, age=0, direction=rng.randint(0, 3))\n        moved[child_pos] = child\n\n        moved[pos] = Agent(\n            energy=parent.energy - config.reproduction_cost,\n            age=parent.age,\n            direction=parent.direction,\n        )\n        births += 1\n\n    # PHASE 4 \u2014 DEATH\n    new_agents: Dict[Position, Agent] = {}\n    for pos in sorted(moved):\n        a = moved[pos]\n        if a.energy <= 0 or a.age > config.max_age:\n            deaths += 1\n        else:\n            new_agents[pos] = a\n\n    # INVARIANT\n    assert len(agents) + births - deaths == len(\n        new_agents\n    ), \"Population accounting invariant violated\"\n\n    return new_agents, births, deaths, movements\n",
      "path": "worldsim/rules.py"
    }
  ]
}
