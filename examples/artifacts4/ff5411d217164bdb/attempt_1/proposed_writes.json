{
  "summary": "Added deterministic core simulation pytest suite covering world creation, stepping, invariants, collision safety, energy/age properties, and ruleset purity; updated verification script to run pytest.",
  "writes": [
    {
      "base_sha256": "87945f9eaa188bf4f4412f9522bb7f40e85e870de32d966c7aee07c921ac5887",
      "content": "#!/usr/bin/env bash\nset -euo pipefail\npython -m compileall -q .\npython -m pytest -q\n",
      "path": "scripts/verify.sh"
    },
    {
      "base_sha256": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
      "content": "import copy\n\nimport pytest\n\nfrom worldsim.rules import default_ruleset\nfrom worldsim.types import Agent, Position, SimConfig, StepResult, WorldState\nfrom worldsim.world import create_world\n\n\ndef _agents_dict(state: WorldState):\n    return {pos: agent for pos, agent in state.agents}\n\n\ndef _positions(state: WorldState):\n    return [pos for pos, _ in state.agents]\n\n\ndef _pop(state: WorldState) -> int:\n    return len(state.agents)\n\n\ndef test_create_world_returns_worldstate_dimensions_step_and_population_for_density_gt_0():\n    config = SimConfig(width=10, height=8, seed=123, initial_density=0.4)\n    world = create_world(config)\n    state = world.get_state()\n\n    assert isinstance(state, WorldState)\n    assert state.width == config.width\n    assert state.height == config.height\n    assert state.step_number == 0\n    assert state.seed == config.seed\n    assert len(state.agents) > 0\n\n\ndef test_create_world_determinism_same_config_produces_identical_worldstate():\n    config = SimConfig(width=12, height=9, seed=999, initial_density=0.25)\n\n    w1 = create_world(config)\n    w2 = create_world(config)\n\n    assert w1.get_state() == w2.get_state()\n\n\ndef test_step_increments_step_number_by_one():\n    config = SimConfig(width=10, height=10, seed=7, initial_density=0.2)\n    world = create_world(config)\n\n    before = world.get_state()\n    result = world.step()\n\n    assert isinstance(result, StepResult)\n    assert result.world.step_number == before.step_number + 1\n\n\ndef test_step_determinism_same_initial_state_twice_produces_identical_stepresult():\n    config = SimConfig(width=14, height=11, seed=2024, initial_density=0.3)\n\n    w1 = create_world(config)\n    w2 = create_world(config)\n\n    r1 = w1.step()\n    r2 = w2.step()\n\n    assert r1 == r2\n\n\ndef test_population_invariant_holds_for_10_steps():\n    config = SimConfig(width=20, height=15, seed=42, initial_density=0.35)\n    world = create_world(config)\n\n    for _ in range(10):\n        before = world.get_state()\n        pop_before = _pop(before)\n\n        result = world.step()\n        after = result.world\n        pop_after = _pop(after)\n\n        assert pop_before + result.births - result.deaths == pop_after\n\n\ndef test_no_cell_collisions_after_every_step_positions_unique():\n    config = SimConfig(width=18, height=12, seed=31415, initial_density=0.4)\n    world = create_world(config)\n\n    for _ in range(15):\n        result = world.step()\n        positions = _positions(result.world)\n        assert len(positions) == len(set(positions))\n\n\ndef test_multi_step_determinism_20_steps_from_same_seed_final_states_equal():\n    config = SimConfig(width=16, height=16, seed=123456, initial_density=0.3)\n\n    w1 = create_world(config)\n    w2 = create_world(config)\n\n    for _ in range(20):\n        w1.step()\n        w2.step()\n\n    assert w1.get_state() == w2.get_state()\n\n\ndef test_energy_bounds_all_living_agents_have_energy_gt_0():\n    config = SimConfig(width=15, height=10, seed=77, initial_density=0.3)\n    world = create_world(config)\n\n    for _ in range(10):\n        result = world.step()\n        for _, agent in result.world.agents:\n            assert agent.energy > 0\n\n\ndef test_age_increases_survivors_have_age_gt_0_after_5_steps_sparse_grid():\n    config = SimConfig(width=30, height=30, seed=888, initial_density=0.05)\n    world = create_world(config)\n\n    for _ in range(5):\n        world.step()\n\n    state = world.get_state()\n    # For any survivors, age must be > 0 because age increments each step.\n    for _, agent in state.agents:\n        assert agent.age > 0\n\n\ndef test_default_ruleset_is_pure_does_not_mutate_input_dict():\n    config = SimConfig(width=5, height=5, seed=1, initial_density=0.0)\n\n    agents = {\n        Position(0, 0): Agent(energy=10, age=0, direction=0),\n        Position(1, 1): Agent(energy=12, age=3, direction=2),\n    }\n    agents_before = copy.deepcopy(agents)\n\n    import random\n\n    rng = random.Random(123)\n    _new_agents, _births, _deaths, _movements = default_ruleset(\n        agents, config.width, config.height, config, rng\n    )\n\n    assert agents == agents_before\n",
      "path": "tests/test_simulation.py"
    }
  ]
}
