{
  "summary": "Added deterministic core simulation pytest suite covering world creation, stepping determinism, invariants, collision safety, energy/age properties, and ruleset purity; updated verification script to run pytest. Fixed age test to account for newborn agents by only asserting age>0 for agents that existed initially and survived.",
  "writes": [
    {
      "base_sha256": "87945f9eaa188bf4f4412f9522bb7f40e85e870de32d966c7aee07c921ac5887",
      "content": "#!/usr/bin/env bash\nset -euo pipefail\npython -m compileall -q .\npython -m pytest -q\n",
      "path": "scripts/verify.sh"
    },
    {
      "base_sha256": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
      "content": "import copy\n\nfrom worldsim.types import SimConfig\nfrom worldsim.world import World, create_world\nfrom worldsim.rules import default_ruleset\n\n\ndef _agents_dict(state):\n    return {pos: agent for pos, agent in state.agents}\n\n\ndef _positions_set(state):\n    return {pos for pos, _ in state.agents}\n\n\ndef test_create_world_returns_worldstate_correct_dimensions_step0_and_agents_for_density_gt_0():\n    config = SimConfig(width=10, height=8, seed=123, initial_density=0.4)\n    world = create_world(config)\n    state = world.get_state()\n\n    assert state.width == config.width\n    assert state.height == config.height\n    assert state.step_number == 0\n    assert state.seed == config.seed\n    assert len(state.agents) > 0\n\n\ndef test_create_world_determinism_same_config_produces_identical_worldstate():\n    config = SimConfig(width=12, height=9, seed=999, initial_density=0.25)\n    w1 = create_world(config)\n    w2 = create_world(config)\n\n    assert w1.get_state() == w2.get_state()\n\n\ndef test_step_increments_step_number_by_1():\n    config = SimConfig(width=10, height=10, seed=7, initial_density=0.2)\n    world = create_world(config)\n    before = world.get_state().step_number\n    world.step()\n    after = world.get_state().step_number\n    assert after == before + 1\n\n\ndef test_step_determinism_same_initial_state_twice_produces_identical_stepresult():\n    config = SimConfig(width=15, height=10, seed=42, initial_density=0.3)\n    w1 = create_world(config)\n    w2 = create_world(config)\n\n    r1 = w1.step()\n    r2 = w2.step()\n\n    assert r1 == r2\n\n\ndef test_population_invariant_over_10_steps():\n    config = SimConfig(width=20, height=20, seed=101, initial_density=0.35)\n    world = create_world(config)\n\n    for _ in range(10):\n        pop_before = len(world.get_state().agents)\n        result = world.step()\n        pop_after = len(result.world.agents)\n        assert pop_before + result.births - result.deaths == pop_after\n\n\ndef test_no_cell_collisions_positions_unique_after_each_step():\n    config = SimConfig(width=25, height=25, seed=202, initial_density=0.4)\n    world = create_world(config)\n\n    for _ in range(15):\n        result = world.step()\n        positions = [pos for pos, _ in result.world.agents]\n        assert len(positions) == len(set(positions))\n\n\ndef test_multi_step_determinism_20_steps_same_seed_final_states_equal():\n    config = SimConfig(width=18, height=18, seed=303, initial_density=0.3)\n    w1 = create_world(config)\n    w2 = create_world(config)\n\n    for _ in range(20):\n        w1.step()\n        w2.step()\n\n    assert w1.get_state() == w2.get_state()\n\n\ndef test_energy_bounds_all_living_agents_have_energy_gt_0():\n    config = SimConfig(width=20, height=20, seed=404, initial_density=0.3)\n    world = create_world(config)\n\n    for _ in range(10):\n        result = world.step()\n        for _, agent in result.world.agents:\n            assert agent.energy > 0\n\n\ndef test_age_increases_survivors_from_initial_population_have_age_gt_0_after_5_steps_sparse_grid():\n    config = SimConfig(width=30, height=30, seed=888, initial_density=0.05)\n    world = create_world(config)\n\n    initial_state = world.get_state()\n    initial_positions = _positions_set(initial_state)\n\n    for _ in range(5):\n        world.step()\n\n    state = world.get_state()\n    # Newborn agents can have age==0; only assert for agents that existed initially and survived.\n    for pos, agent in state.agents:\n        if pos in initial_positions:\n            assert agent.age > 0\n\n\ndef test_rules_pure_function_default_ruleset_does_not_mutate_input_dict():\n    config = SimConfig(width=10, height=10, seed=1, initial_density=0.2)\n    world = create_world(config)\n    state = world.get_state()\n\n    agents = _agents_dict(state)\n    agents_before = copy.deepcopy(agents)\n\n    # Call ruleset directly with a deterministic RNG.\n    import random\n\n    rng = random.Random(12345)\n    _new_agents, _births, _deaths, _movements = default_ruleset(\n        agents,\n        state.width,\n        state.height,\n        config,\n        rng,\n    )\n\n    assert agents == agents_before\n",
      "path": "tests/test_simulation.py"
    }
  ]
}
