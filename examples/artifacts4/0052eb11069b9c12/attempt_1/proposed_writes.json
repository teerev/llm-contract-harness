{
  "summary": "Added deterministic core simulation tests covering world creation, stepping, invariants, collision safety, energy bounds, newborn counting, and ruleset purity; updated verification script to run pytest.",
  "writes": [
    {
      "base_sha256": "87945f9eaa188bf4f4412f9522bb7f40e85e870de32d966c7aee07c921ac5887",
      "content": "#!/usr/bin/env bash\nset -euo pipefail\npython -m compileall -q .\npython -m pytest -q\n",
      "path": "scripts/verify.sh"
    },
    {
      "base_sha256": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
      "content": "import copy\n\nfrom worldsim.rules import default_ruleset\nfrom worldsim.types import Position, SimConfig\nfrom worldsim.world import World, create_world\n\n\ndef _agents_dict(world_state):\n    \"\"\"Convert WorldState.agents tuple into a dict for convenience.\"\"\"\n    return {pos: agent for pos, agent in world_state.agents}\n\n\ndef _positions(world_state):\n    return [pos for pos, _ in world_state.agents]\n\n\ndef test_create_world_returns_worldstate_dimensions_step_and_agents_for_density_gt_0():\n    config = SimConfig(width=10, height=8, seed=123, initial_density=0.6)\n    world = create_world(config)\n    state = world.get_state()\n\n    assert state.width == config.width\n    assert state.height == config.height\n    assert state.step_number == 0\n    assert len(state.agents) > 0\n\n\ndef test_create_world_determinism_same_config_produces_identical_worldstate():\n    config = SimConfig(width=12, height=7, seed=999, initial_density=0.35)\n    w1 = create_world(config)\n    w2 = create_world(config)\n\n    assert w1.get_state() == w2.get_state()\n\n\ndef test_step_increments_step_number_by_1():\n    config = SimConfig(width=10, height=10, seed=1, initial_density=0.4)\n    world = create_world(config)\n    before = world.get_state().step_number\n    result = world.step()\n\n    assert result.world.step_number == before + 1\n    assert world.get_state().step_number == before + 1\n\n\ndef test_step_determinism_same_initial_state_twice_produces_identical_stepresult():\n    config = SimConfig(width=9, height=9, seed=42, initial_density=0.5)\n    w1 = create_world(config)\n    w2 = create_world(config)\n\n    r1 = w1.step()\n    r2 = w2.step()\n\n    assert r1 == r2\n\n\ndef test_population_invariant_holds_for_10_steps():\n    config = SimConfig(width=14, height=10, seed=7, initial_density=0.45)\n    world = create_world(config)\n\n    for _ in range(10):\n        pop_before = len(world.get_state().agents)\n        res = world.step()\n        pop_after = len(res.world.agents)\n        assert pop_before + res.births - res.deaths == pop_after\n\n\ndef test_no_cell_collisions_positions_unique_after_every_step():\n    config = SimConfig(width=16, height=12, seed=2024, initial_density=0.55)\n    world = create_world(config)\n\n    for _ in range(15):\n        res = world.step()\n        positions = _positions(res.world)\n        assert len(positions) == len(set(positions))\n\n\ndef test_multi_step_determinism_20_steps_same_seed_final_states_equal():\n    config = SimConfig(width=20, height=10, seed=314159, initial_density=0.3)\n    w1 = create_world(config)\n    w2 = create_world(config)\n\n    for _ in range(20):\n        w1.step()\n        w2.step()\n\n    assert w1.get_state() == w2.get_state()\n\n\ndef test_energy_bounds_all_living_agents_have_energy_gt_0():\n    config = SimConfig(width=13, height=13, seed=88, initial_density=0.5)\n    world = create_world(config)\n\n    for _ in range(10):\n        res = world.step()\n        for _, agent in res.world.agents:\n            assert agent.energy > 0\n\n\ndef test_newborn_counting_age_0_equals_births_each_step():\n    # Phase 1 ages all pre-existing agents to age>=1; Phase 3 creates newborns at age 0.\n    config = SimConfig(width=18, height=12, seed=1234, initial_density=0.5)\n    world = create_world(config)\n\n    for _ in range(12):\n        res = world.step()\n        newborns = sum(1 for _, a in res.world.agents if a.age == 0)\n        assert newborns == res.births\n\n\ndef test_default_ruleset_is_pure_does_not_mutate_input_dict():\n    config = SimConfig(width=6, height=6, seed=5, initial_density=0.4)\n    world = create_world(config)\n    state = world.get_state()\n\n    agents_in = _agents_dict(state)\n    agents_before = copy.deepcopy(agents_in)\n\n    # Use a deterministic RNG; purity here refers to not mutating the input mapping.\n    import random\n\n    rng = random.Random(0)\n    _new_agents, _births, _deaths, _movements = default_ruleset(\n        agents_in, state.width, state.height, config, rng\n    )\n\n    assert agents_in == agents_before\n",
      "path": "tests/test_simulation.py"
    }
  ]
}
