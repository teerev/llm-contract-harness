{
  "summary": "Added comprehensive integration tests covering stats, ASCII rendering, checkpoint save/load and resume determinism, HTML rendering output structure, and end-to-end deterministic simulation behavior.",
  "writes": [
    {
      "base_sha256": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
      "content": "import os\nimport tempfile\nimport unittest\n\nfrom worldsim.checkpoint import load_checkpoint, save_checkpoint\nfrom worldsim.render_ascii import render_ascii\nfrom worldsim.render_html import render_html\nfrom worldsim.stats import StatsCollector\nfrom worldsim.types import Agent, Position, SimConfig, StepResult, WorldState\nfrom worldsim.world import World, create_world\n\n\nclass TestStatsIntegration(unittest.TestCase):\n    def test_record_returns_tickmetrics_population_and_density(self) -> None:\n        state = WorldState(\n            width=4,\n            height=5,\n            step_number=7,\n            seed=123,\n            agents=(\n                (Position(0, 0), Agent(energy=10, age=0, direction=0)),\n                (Position(4, 3), Agent(energy=1, age=2, direction=1)),\n            ),\n        )\n        step_result = StepResult(world=state, births=1, deaths=0, movements=2)\n\n        sc = StatsCollector()\n        m = sc.record(step_result)\n\n        self.assertEqual(m.step_number, 7)\n        self.assertEqual(m.population, 2)\n        self.assertAlmostEqual(m.density, 2 / (4 * 5))\n\n    def test_to_csv_header_and_row_count_after_n_records(self) -> None:\n        sc = StatsCollector()\n        for i in range(3):\n            state = WorldState(\n                width=2,\n                height=2,\n                step_number=i,\n                seed=1,\n                agents=((Position(0, 0), Agent(energy=10, age=i, direction=0)),),\n            )\n            sc.record(StepResult(world=state, births=0, deaths=0, movements=0))\n\n        csv_text = sc.to_csv()\n        lines = csv_text.splitlines()\n        self.assertEqual(lines[0], \"step_number,population,births,deaths,avg_energy,density\")\n        self.assertEqual(len(lines), 1 + 3)\n\n    def test_avg_energy_is_zero_when_population_is_zero(self) -> None:\n        sc = StatsCollector()\n        state = WorldState(width=3, height=3, step_number=0, seed=0, agents=())\n        m = sc.record(StepResult(world=state, births=0, deaths=0, movements=0))\n        self.assertEqual(m.population, 0)\n        self.assertEqual(m.avg_energy, 0.0)\n\n\nclass TestAsciiRenderIntegration(unittest.TestCase):\n    def test_render_ascii_dimensions(self) -> None:\n        state = WorldState(\n            width=4,\n            height=3,\n            step_number=0,\n            seed=0,\n            agents=(),\n        )\n        out = render_ascii(state)\n        lines = out.split(\"\\n\")\n        self.assertEqual(len(lines), 3)\n        for line in lines:\n            self.assertEqual(len(line), 4)\n\n    def test_render_ascii_agent_glyphs_and_positions(self) -> None:\n        # '@' for energy>5, 'o' for energy 1-5\n        state = WorldState(\n            width=5,\n            height=4,\n            step_number=0,\n            seed=0,\n            agents=(\n                (Position(1, 2), Agent(energy=6, age=0, direction=0)),  # '@'\n                (Position(3, 4), Agent(energy=5, age=0, direction=0)),  # 'o'\n            ),\n        )\n        out = render_ascii(state)\n        lines = out.split(\"\\n\")\n        self.assertEqual(lines[1][2], \"@\")\n        self.assertEqual(lines[3][4], \"o\")\n\n    def test_render_ascii_determinism_same_state_renders_identically(self) -> None:\n        state = WorldState(\n            width=3,\n            height=2,\n            step_number=0,\n            seed=0,\n            agents=(\n                (Position(0, 1), Agent(energy=2, age=0, direction=0)),\n                (Position(1, 2), Agent(energy=9, age=0, direction=0)),\n            ),\n        )\n        a = render_ascii(state)\n        b = render_ascii(state)\n        self.assertEqual(a, b)\n\n\nclass TestCheckpointIntegration(unittest.TestCase):\n    def test_save_then_load_produces_identical_worldstate(self) -> None:\n        state = WorldState(\n            width=6,\n            height=4,\n            step_number=12,\n            seed=99,\n            agents=(\n                (Position(0, 0), Agent(energy=10, age=1, direction=2)),\n                (Position(3, 5), Agent(energy=3, age=4, direction=1)),\n            ),\n        )\n\n        tmpdir = tempfile.mkdtemp()\n        path = os.path.join(tmpdir, \"checkpoint.json\")\n        save_checkpoint(state, path)\n        loaded = load_checkpoint(path)\n        self.assertEqual(state, loaded)\n\n    def test_round_trip_with_empty_agents_works(self) -> None:\n        state = WorldState(width=2, height=2, step_number=0, seed=1, agents=())\n        tmpdir = tempfile.mkdtemp()\n        path = os.path.join(tmpdir, \"empty.json\")\n        save_checkpoint(state, path)\n        loaded = load_checkpoint(path)\n        self.assertEqual(state, loaded)\n        self.assertEqual(loaded.agents, ())\n\n    def test_checkpoint_resume_matches_straight_run(self) -> None:\n        config = SimConfig(width=10, height=8, seed=123, initial_density=0.25, max_steps=100)\n\n        # Run 10 steps straight\n        w1 = create_world(config)\n        for _ in range(10):\n            w1.step()\n        final_straight = w1.get_state()\n\n        # Run 5 steps, checkpoint, load into new World, run 5 more\n        w2 = create_world(config)\n        for _ in range(5):\n            w2.step()\n        mid = w2.get_state()\n\n        tmpdir = tempfile.mkdtemp()\n        path = os.path.join(tmpdir, \"resume.json\")\n        save_checkpoint(mid, path)\n        loaded_mid = load_checkpoint(path)\n\n        w3 = World(config=config, state=loaded_mid, ruleset=None)\n        for _ in range(5):\n            w3.step()\n        final_resumed = w3.get_state()\n\n        self.assertEqual(final_straight, final_resumed)\n\n\nclass TestHtmlRenderIntegration(unittest.TestCase):\n    def test_render_html_starts_with_doctype(self) -> None:\n        states = [\n            WorldState(width=2, height=2, step_number=0, seed=0, agents=()),\n        ]\n        tmpdir = tempfile.mkdtemp()\n        path = os.path.join(tmpdir, \"out.html\")\n        render_html(states, path)\n        with open(path, \"r\", encoding=\"utf-8\") as f:\n            start = f.read(20)\n        self.assertTrue(start.startswith(\"<!DOCTYPE\"))\n\n    def test_render_html_contains_canvas_and_frame_data(self) -> None:\n        states = [\n            WorldState(\n                width=3,\n                height=3,\n                step_number=0,\n                seed=0,\n                agents=((Position(1, 1), Agent(energy=10, age=0, direction=0)),),\n            ),\n            WorldState(\n                width=3,\n                height=3,\n                step_number=1,\n                seed=0,\n                agents=((Position(1, 2), Agent(energy=9, age=1, direction=1)),),\n            ),\n        ]\n        tmpdir = tempfile.mkdtemp()\n        path = os.path.join(tmpdir, \"frames.html\")\n        render_html(states, path)\n        with open(path, \"r\", encoding=\"utf-8\") as f:\n            html = f.read()\n\n        self.assertIn(\"<canvas\", html)\n        self.assertIn(\"const FRAMES = \", html)\n        # Frame data should include at least one step number and an agents array.\n        self.assertIn('\"step\":0', html)\n        self.assertIn('\"agents\":', html)\n\n    def test_render_html_file_size_gt_500_bytes_for_non_trivial_input(self) -> None:\n        states = []\n        for i in range(5):\n            states.append(\n                WorldState(\n                    width=20,\n                    height=10,\n                    step_number=i,\n                    seed=0,\n                    agents=(\n                        (Position(i % 10, i % 20), Agent(energy=10 + i, age=i, direction=i % 4)),\n                        (Position((i + 3) % 10, (i + 7) % 20), Agent(energy=3, age=0, direction=2)),\n                    ),\n                )\n            )\n\n        tmpdir = tempfile.mkdtemp()\n        path = os.path.join(tmpdir, \"big.html\")\n        render_html(states, path)\n        size = os.path.getsize(path)\n        self.assertGreater(size, 500)\n\n\nclass TestEndToEndDeterminism(unittest.TestCase):\n    def test_full_pipeline_determinism_same_seed_same_final_state(self) -> None:\n        config = SimConfig(width=12, height=9, seed=2024, initial_density=0.3, max_steps=100)\n\n        w1 = create_world(config)\n        for _ in range(10):\n            w1.step()\n        s1 = w1.get_state()\n\n        w2 = create_world(config)\n        for _ in range(10):\n            w2.step()\n        s2 = w2.get_state()\n\n        self.assertEqual(s1, s2)\n\n\nif __name__ == \"__main__\":\n    unittest.main()\n",
      "path": "tests/test_integration.py"
    }
  ]
}
